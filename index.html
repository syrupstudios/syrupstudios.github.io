<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        margin: 0;
        background-color: #1b1a1d; /* Optional, for better visibility */
        overflow: hidden;
      }

      .wrapper {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #app {
        color: #d24949;
        font-family: monospace;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 3.8px solid #f0f0f0;
        animation: spinner-bulqg1 0.6400000000000001s infinite linear alternate,
          spinner-oaa3wk 1.2800000000000002s infinite linear;
      }

      @keyframes spinner-bulqg1 {
        0% {
          clip-path: polygon(
            50% 50%,
            0 0,
            50% 0%,
            50% 0%,
            50% 0%,
            50% 0%,
            50% 0%
          );
        }

        12.5% {
          clip-path: polygon(
            50% 50%,
            0 0,
            50% 0%,
            100% 0%,
            100% 0%,
            100% 0%,
            100% 0%
          );
        }

        25% {
          clip-path: polygon(
            50% 50%,
            0 0,
            50% 0%,
            100% 0%,
            100% 100%,
            100% 100%,
            100% 100%
          );
        }

        50% {
          clip-path: polygon(
            50% 50%,
            0 0,
            50% 0%,
            100% 0%,
            100% 100%,
            50% 100%,
            0% 100%
          );
        }

        62.5% {
          clip-path: polygon(
            50% 50%,
            100% 0,
            100% 0%,
            100% 0%,
            100% 100%,
            50% 100%,
            0% 100%
          );
        }

        75% {
          clip-path: polygon(
            50% 50%,
            100% 100%,
            100% 100%,
            100% 100%,
            100% 100%,
            50% 100%,
            0% 100%
          );
        }

        100% {
          clip-path: polygon(
            50% 50%,
            50% 100%,
            50% 100%,
            50% 100%,
            50% 100%,
            50% 100%,
            0% 100%
          );
        }
      }

      @keyframes spinner-oaa3wk {
        0% {
          transform: scaleY(1) rotate(0deg);
        }
        49.99% {
          transform: scaleY(1) rotate(135deg);
        }
        50% {
          transform: scaleY(-1) rotate(0deg);
        }
        100% {
          transform: scaleY(-1) rotate(-135deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <div class="wrapper">
      <div class="spinner"></div>
    </div>

    <script>
      // ‚úÖ CONFIGURATION
      const GITHUB_PAT = ""; // üîÅ Replace with your real token
      const REPO = "syrupstudios/PRIVATE"; // üîÅ Format: username/repo
      const BRANCH = "main";
      const folder =
        new URLSearchParams(window.location.search).get("p") || "index";

      // ‚úÖ Fetch folder file listing
      async function fetchGitHubFolder(path) {
        const apiUrl = `https://api.github.com/repos/${REPO}/contents/${path}?ref=${BRANCH}`;
        const res = await fetch(apiUrl, {
          headers: {
            Authorization: `token ${GITHUB_PAT}`,
            Accept: "application/vnd.github.v3+json",
          },
        });

        if (res.status === 401) {
          // PAT issue - Unauthorized
          throw new Error(
            "Unauthorized: an error occured while accessing the server."
          );
        }

        if (res.status === 404) {
          // Folder not found
          throw new Error("Folder not found: Redirecting to 404 folder.");
        }

        if (!res.ok) {
          throw new Error(`GitHub fetch failed: ${res.statusText}`);
        }

        return res.json();
      }

      // ‚úÖ Fetch raw file content
      async function fetchFileContent(fileApiUrl) {
        const res = await fetch(fileApiUrl, {
          headers: {
            Authorization: `token ${GITHUB_PAT}`,
            Accept: "application/vnd.github.v3.raw",
          },
        });
        if (!res.ok) throw new Error(`Failed to fetch file: ${res.statusText}`);
        return res.text();
      }

      // ‚úÖ Download and cache all files in folder
      async function downloadFolder(path) {
        const files = await fetchGitHubFolder(path);
        const store = {};
        let version = null;
        let access = null;

        // Only attempt to fetch version.txt if folder exists
        for (const file of files) {
          if (file.type === "file") {
            const content = await fetchFileContent(file.url);
            store[file.name] = content;

            // If the version.txt file is found, extract the version and access
            if (file.name === "version.txt") {
              const versionContent = await fetchFileContent(file.url);
              const versionData = JSON.parse(versionContent.trim());
              version = versionData[0].VERSION;
              access = versionData[1].ACCESS;
            }
          }
        }
        store["version"] = version;
        store["access"] = access; // Store the access in the cache
        localStorage.setItem(`folder_${path}`, JSON.stringify(store));
        return store;
      }

      // ‚úÖ Load folder from cache
      function getCachedFolder(path) {
        const data = localStorage.getItem(`folder_${path}`);
        return data ? JSON.parse(data) : null;
      }

      // ‚úÖ Get version and access from version.txt
      async function getVersionAndAccess(path) {
        const folderData = await fetchGitHubFolder(path);
        const versionFile = folderData.find((f) => f.name === "version.txt");
        if (!versionFile) throw new Error("version.txt not found");

        const versionContent = await fetchFileContent(versionFile.url);
        const versionData = JSON.parse(versionContent.trim());

        const version = versionData[0].VERSION;
        const access = versionData[1].ACCESS;

        return { version, access };
      }

      // ‚úÖ Check for updates and download if needed
      async function ensureFolder(path) {
        const cacheKey = `folder_${path}`;
        const cached = getCachedFolder(path);
        try {
          // Check if folder exists, if not, immediately exit.
          await fetchGitHubFolder(path);

          // Folder exists, proceed to fetch version and access
          const { version, access } = await getVersionAndAccess(path);

          // Convert access to lowercase for case-insensitive comparison
          if (access && access.toLowerCase() === "restricted") {
            document.getElementById("app").innerText =
              "Access Denied: This page is restricted.";
            return; // Don't try to load any files if access is restricted
          }

          // If there‚Äôs no cached version or if the version or access level has changed, re-download
          const cachedVersion = cached ? cached["version"] : null;
          const cachedAccess = cached ? cached["access"] : null;

          // Check if either version or access has changed
          if (cachedVersion !== version || cachedAccess !== access) {
            console.log(
              "Version or access level mismatch. Clearing old cache and downloading fresh..."
            );
            localStorage.removeItem(cacheKey); // ‚úÖ Wipe old cache
            return await downloadFolder(path); // ‚úÖ Redownload new
          } else {
            console.log("Using cached version.");
            return cached;
          }
        } catch (e) {
          // Handle known errors early before trying to overwrite the document
          if (e.message.includes("Folder not found")) {
            // Folder not found (404) ‚Äì redirect to "404" folder
            console.log("Folder not found, redirecting to 404 folder...");
            document.getElementById("app").innerText =
              "Folder not found. Redirecting to 404.";
            window.location.search = "?p=404"; // Redirect to 404 folder
          } else if (e.message.includes("Unauthorized")) {
            // PAT or authentication issue
            document.getElementById("app").innerText =
              "Authentication failed: an error occured accessing the server.";
          } else if (e.message.includes("GitHub fetch failed")) {
            // GitHub API or internet connection error
            document.getElementById("app").innerText =
              "Server error: Unable to fetch content from GitHub. Please check your internet connection or permissions.";
          } else {
            console.warn("Unknown error: ", e);
            document.getElementById("app").innerText =
              "An unknown error occurred.";
          }
        }
      }

      // ‚úÖ Create Blob URL for a given JS or CSS content
      function createBlobUrl(content, type) {
        const blob = new Blob([content], { type });
        return URL.createObjectURL(blob);
      }

      // ‚úÖ Inject HTML with linked Blob URLs for CSS & JS
      function writeHTMLToDocument(folderData) {
        let html = folderData["index.html"];
        if (!html) {
          document.body.innerHTML = "index.html not found.";
          return;
        }

        // Parse index.html so we can manipulate its DOM
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        // Handle <link rel="stylesheet">
        const linkTags = [...doc.querySelectorAll('link[rel="stylesheet"]')];
        linkTags.forEach((link) => {
          const href = link.getAttribute("href");
          const css = folderData[href];
          if (css) {
            const blobUrl = createBlobUrl(css, "text/css");
            link.setAttribute("href", blobUrl); // Link to the Blob URL
          }
        });

        // Handle <script src="...">
        const scriptTags = [...doc.querySelectorAll("script[src]")];
        scriptTags.forEach((script) => {
          const src = script.getAttribute("src");
          const js = folderData[src];
          if (js) {
            const blobUrl = createBlobUrl(js, "application/javascript");
            script.setAttribute("src", blobUrl); // Link to the Blob URL
          }
        });

        // Rewrite the whole document with linked Blob URLs
        document.open();
        document.write(doc.documentElement.outerHTML);
        document.close();
      }

      // üîÅ Bootstrap the app
      (async function init() {
        try {
          const folderData = await ensureFolder(folder);
          if (folderData) {
            writeHTMLToDocument(folderData); // Only inject HTML if content is available
          }
        } catch (err) {
          console.error(err);
          document.getElementById("app").innerText = "Failed to load content.";
        }
      })();
    </script>
  </body>
</html>
